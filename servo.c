#include <avr/io.h>
#include "servo.h"
#include "timer.h"
/////////////////////////////////////////////////////////////////////////////
// local prototypes
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// library variables
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// constants
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// function implementations
/////////////////////////////////////////////////////////////////////////////


void servo_init(){
    Timer_Init(MHz_Output_4, Timer_Prescale_4, 1); //same as LCD
    TCB0.CTRLA = 0b00000011;//div2
    TCB0.CTRLB = 0b00000000;//no output pwm mode
    TCB0.INTCTRL = 0b00000001; //overflow
    TCB0.CCMP = 40000;
    PORTA.DIRSET = 0b10000000;
}

void servo_angle(float num){
    int b = 30;
    TCB0.CNT = 0;
    while(b){
        int a = TCB0.INTFLAGS;
        if(TCB0.CNT > TCB0.CCMP*num){ //ON
            PORTA.OUT |= 0b10000000;
        }
        else if(a & 0b00000001){ // TOP
            PORTA.OUT &= 0b01111111;
            TCB0.INTFLAGS |= 0b00000001;
            b--;
        }
    }
    Timer_Sleep(2);
    
}